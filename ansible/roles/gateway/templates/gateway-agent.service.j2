# vi:syntax=systemd

[Unit]
Description=naisdevice gateway agent

[Service]
Restart=always
# The failure of either of these commands will be logged, but
# the service will still attempt to launch, which might well
# succeed.
{% if proxy_env is defined and proxy_env|length %}
Environment="HTTPS_PROXY={{ proxy_env.https_proxy }}"
{% endif %}
StandardOutput=append:/var/log/naisdevice/gateway-agent.json
StandardError=append:/var/log/naisdevice/gateway-agent.json
ExecStart=/opt/nais-device/bin/gateway-agent \
	--name="{{ name }}" \
	--tunnel-ip="{{ tunnel_ip }}" \
{% if onprem %}
	--public-ip="$(ip -4 -o address show ens160 | awk '{print $4}' | cut -d '/' -f 1)" \
{% else %}
	--public-ip="$(curl -H "Metadata-Flavor: Google" http://metadata.google.internal/computeMetadata/v1/instance/network-interfaces/0/access-configs/0/external-ip)" \
{% endif %}
	--api-server-wireguard-endpoint="35.228.142.96:51820" \
	--api-server-public-key="FUwVtyvs8nIRx9RpUUEopkfV8idmHz9g9K/vf9MFOXI=" \
	--prometheus-public-key="MN9B/ZgAQdgCXH3/KUaUiObwrzHv6zF2P6M4ySTx81M=" \
	--prometheus-tunnel-ip="10.255.247.254"

[Install]
WantedBy=multi-user.target
